generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  // connect_timeout = 20
}
//=============Usuarios===========
model tb_user {
  id         Int        @id @default(autoincrement()) @map("id_usuario")
  tenantId   Int        @map("id_tenant")
  name       String     @map("nombre") @db.VarChar(100)
  email      String     @unique(map: "email") @map("email") @db.VarChar(100)
  password   String     @map("contrasena") @db.VarChar(255)
  roleId     Int        @map("id_rol")
  createdAt  DateTime   @default(now()) @map("fecha_creacion") @db.Timestamp(0)
  role       tb_role       @relation("UserRole", fields: [roleId], references: [id], onUpdate: Restrict, map: "fk_user_rol")
  tb_tenants tb_tenants @relation(fields: [tenantId], references: [id_tenant], onDelete: Cascade, onUpdate: Restrict, map: "fk_user_tenant")

  @@index([roleId], map: "fk_user_rol")
  @@index([tenantId], map: "fk_user_tenant")
  @@map("tb_users")
}
//=============Roles===========
model tb_role {
  id          Int     @id @default(autoincrement()) @map("id_rol")
  nombre      String  @unique(map: "nombre") @map("nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
  users       tb_user[]  @relation("UserRole")

  @@map("tb_roles")
}
//=============tenants por iglesia===========
model tb_tenants {
  id_tenant      Int       @id @default(autoincrement())
  dpi            String    @unique(map: "dpi") @db.VarChar(20)
  nombre         String    @db.VarChar(100)
  email          String    @unique(map: "email") @db.VarChar(100)
  telefono       String?   @db.VarChar(20)
  fecha_inicio   DateTime? @db.Date
  direccion      String?   @db.VarChar(255)
  fecha_creacion DateTime  @default(now()) @db.Timestamp(0)

  grupos         tb_grupo[]
  miembros       tb_miembros[]
  users       tb_user[]
  limpiezas tb_limpieza[]
  actividades tb_actividad[]
  bautizados tb_bautizados[]
  servidores tb_servidores[]

  @@map("tb_tenants")
}

//=============genero===========
model tb_genero {
  idGenero      Int          @id @default(autoincrement())
  nombregenero  String       @db.VarChar(50)
  fechaCreacion DateTime     @default(now()) @db.Timestamp(0)

  miembros tb_miembros[]

  @@map("tb_genero")
}

//=============estado civil===========
model tb_estadocivil {
  idEstado      Int          @id @default(autoincrement())
  nombreEstado  String       @db.VarChar(50)

  miembros tb_miembros[]

  @@map("tb_estadocivil")
}

//=============grupo===========
model tb_grupo {
  idGrupo       Int          @id @default(autoincrement())
  idTenant      Int
  nombregrupo   String       @db.VarChar(100)
  fechaCreacion DateTime     @default(now()) @db.Timestamp(0)

  tenant       tb_tenants   @relation(fields: [idTenant], references: [id_tenant], map: "fk_grupo_tenant")
  miembros     tb_miembros[]
  miembroGrupo tb_miembrogrupo[]
  actividades tb_actividad[]
  limpiezas    tb_limpieza[]

  @@index([idTenant], map: "fk_grupo_tenant")
  @@map("tb_grupo")
}


//=========tb_bautizados=========
model tb_bautizados {
  idBautizado      Int       @id @default(autoincrement())
  idTenant         Int
  bautizadoEstado  String?   @db.VarChar(5)
  fechaCreacion    DateTime  @default(now()) @db.Timestamp(0)

  // Relaciones
  miembros         tb_miembros[]  // relación inversa 1:N
  tenant           tb_tenants     @relation(fields: [idTenant], references: [id_tenant], map: "fk_bautizado_tenant")

  @@index([idTenant], map: "fk_bautizado_tenant")
  @@map("tb_bautizados")
}

//=========tb_servidores=========
model tb_servidores {
  idServidor      Int       @id @default(autoincrement())
  idTenant        Int
  servidorEstado  String?   @db.VarChar(5)
  fechaCreacion   DateTime  @default(now()) @db.Timestamp(0)

  // Relaciones
  miembros        tb_miembros[]  // relación inversa 1:N
  tenant          tb_tenants     @relation(fields: [idTenant], references: [id_tenant], map: "fk_servidor_tenant")

  @@index([idTenant], map: "fk_servidor_tenant")
  @@map("tb_servidores")
}

//=========tb_miembros=========
model tb_miembros {
  idMiembro         Int       @id @default(autoincrement())
  idTenant          Int
  dpi               String?   @db.VarChar(20)
  nombre            String    @db.VarChar(100)
  apellido          String    @db.VarChar(100)
  email             String?   @db.VarChar(100)
  telefono          String?   @db.VarChar(20)
  fechanacimiento   DateTime? @db.Date
  idGenero          Int?
  direccion         String?   @db.VarChar(255)
  idEstado          Int?
  fechaLlegada      DateTime? @db.Date
  fechaBautismo    DateTime? @db.Date
  procesosterminado String?   @db.VarChar(255)
  idGrupo           Int?
  legusta           String?   @db.Text
  fechaCreacion     DateTime  @default(now()) @db.Timestamp(0)

  // Relaciones FKs
  idBautizado       Int?      // FK a tb_bautizados
  idServidor        Int?      // FK a tb_servidores

  // Relaciones
  tenant        tb_tenants      @relation(fields: [idTenant], references: [id_tenant], map: "fk_miembro_tenant")
  genero        tb_genero?      @relation(fields: [idGenero], references: [idGenero], map: "fk_miembro_genero")
  estadoCivil   tb_estadocivil? @relation(fields: [idEstado], references: [idEstado], map: "fk_miembro_estado")
  grupo         tb_grupo?       @relation(fields: [idGrupo], references: [idGrupo], map: "fk_miembro_grupo")
  bautizado     tb_bautizados?  @relation(fields: [idBautizado], references: [idBautizado])
  servidor      tb_servidores?  @relation(fields: [idServidor], references: [idServidor])

  miembroGrupo  tb_miembrogrupo[]
  limpiezas     tb_limpieza[]
  actividades   tb_actividad[]

  @@index([idTenant], map: "fk_miembro_tenant")
  @@index([idGenero], map: "fk_miembro_genero")
  @@index([idEstado], map: "fk_miembro_estado")
  @@index([idGrupo], map: "fk_miembro_grupo")
  @@map("tb_miembros")
}


//=============miembroGrupo muchos a muchos===========
model tb_miembrogrupo {
  idMiembro   Int
  idGrupo     Int
  fechaUnion  DateTime @default(now()) @db.Date

  miembro tb_miembros @relation(fields: [idMiembro], references: [idMiembro], onDelete: Cascade, map: "fk_miembrogrupo_miembro")
  grupo   tb_grupo    @relation(fields: [idGrupo], references: [idGrupo], onDelete: Cascade, map: "fk_miembrogrupo_grupo")

  @@id([idMiembro, idGrupo])
  @@map("tb_miembrogrupo")
}

//=============tb_limpieza===========
model tb_limpieza {
  idLimpieza    Int       @id @default(autoincrement())
  idTenant      Int
  idMiembro     Int?
  idGrupo       Int?
  fechaLimpieza DateTime
  fechaCreacion DateTime  @default(now()) @db.Timestamp(0)

  miembro tb_miembros? @relation(fields: [idMiembro], references: [idMiembro], onDelete: Cascade)
  grupo   tb_grupo?    @relation(fields: [idGrupo], references: [idGrupo], onDelete: Cascade)
  tenant  tb_tenants   @relation(fields: [idTenant], references: [id_tenant], onDelete: Cascade)

  @@map("tb_limpieza")
}

//==================tb_actividades==================
model tb_actividad {
  idActividad   Int          @id @default(autoincrement())
  idTenant      Int
  idMiembro     Int
  idGrupo       Int?
  titulo        String
  descripcion   String?
  fechaActividad DateTime
  fechaCreacion DateTime     @default(now())

  tenant        tb_tenants   @relation(fields: [idTenant], references: [id_tenant], onDelete: Cascade)
  miembro       tb_miembros  @relation(fields: [idMiembro], references: [idMiembro], onDelete: Cascade)
  grupo         tb_grupo?    @relation(fields: [idGrupo], references: [idGrupo], onDelete: SetNull)

  @@map("tb_actividades")
}
